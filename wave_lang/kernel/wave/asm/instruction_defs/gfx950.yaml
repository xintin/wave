# GFX950 (CDNA3+ / MI350) specific instructions and overrides
#
# This file extends common.yaml with instructions specific to GFX950.
# GFX950 builds on GFX942 with additional features.
#
# GFX950 features:
# - All GFX942 features plus:
# - Enhanced FP8/BF8 support
# - Improved gather-to-LDS operations
# - Higher memory bandwidth

instructions:
  # ===========================================================================
  # GFX950-specific MFMA Instructions (same as GFX942 + improvements)
  # ===========================================================================

  # FP8 Matrix Multiply-Add
  v_mfma_f32_16x16x32_fp8_fp8:
    mnemonic: v_mfma_f32_16x16x32_fp8_fp8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 48  # Improved over GFX942
    architectures: [gfx950]
    special:
      accumulator: true

  v_mfma_f32_32x32x16_fp8_fp8:
    mnemonic: v_mfma_f32_32x32x16_fp8_fp8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_16, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_16}
    latency: 48
    architectures: [gfx950]
    special:
      accumulator: true

  v_mfma_f32_16x16x32_bf8_bf8:
    mnemonic: v_mfma_f32_16x16x32_bf8_bf8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 48
    architectures: [gfx950]
    special:
      accumulator: true

  v_mfma_f32_32x32x16_bf8_bf8:
    mnemonic: v_mfma_f32_32x32x16_bf8_bf8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_16, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_16}
    latency: 48
    architectures: [gfx950]
    special:
      accumulator: true

  # Mixed precision MFMA
  v_mfma_f32_16x16x32_fp8_bf8:
    mnemonic: v_mfma_f32_16x16x32_fp8_bf8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 48
    architectures: [gfx950]
    special:
      accumulator: true

  v_mfma_f32_16x16x32_bf8_fp8:
    mnemonic: v_mfma_f32_16x16x32_bf8_fp8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 48
    architectures: [gfx950]
    special:
      accumulator: true

  # ===========================================================================
  # GFX950 Standard MFMA (improved latency)
  # ===========================================================================

  v_mfma_f32_16x16x16_f16:
    mnemonic: v_mfma_f32_16x16x16_f16
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 24  # Even better than GFX942
    architectures: [gfx950]
    special:
      accumulator: true

  v_mfma_f32_32x32x8_f16:
    mnemonic: v_mfma_f32_32x32x8_f16
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_16, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_16}
    latency: 24
    architectures: [gfx950]
    special:
      accumulator: true

  # ===========================================================================
  # GFX950-specific Conversion Instructions
  # ===========================================================================

  v_cvt_pk_fp8_f32:
    mnemonic: v_cvt_pk_fp8_f32
    category: valu
    format: vop3p
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src0, type: vgpr|sgpr|imm}
      - {name: src1, type: vgpr|sgpr|imm}
    latency: 2  # Faster on GFX950
    architectures: [gfx950]

  v_cvt_pk_bf8_f32:
    mnemonic: v_cvt_pk_bf8_f32
    category: valu
    format: vop3p
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src0, type: vgpr|sgpr|imm}
      - {name: src1, type: vgpr|sgpr|imm}
    latency: 2
    architectures: [gfx950]

  v_cvt_f32_fp8:
    mnemonic: v_cvt_f32_fp8
    category: valu
    format: vop1
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src, type: vgpr|sgpr|imm}
    latency: 2
    architectures: [gfx950]

  v_cvt_f32_bf8:
    mnemonic: v_cvt_f32_bf8
    category: valu
    format: vop1
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src, type: vgpr|sgpr|imm}
    latency: 2
    architectures: [gfx950]

  # ===========================================================================
  # GFX950 Memory Operations (improved latency)
  # ===========================================================================

  buffer_load_dword:
    mnemonic: buffer_load_dword
    category: vmem
    format: mtbuf
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: vaddr, type: vgpr}
      - {name: srd, type: sgpr_quad}
      - {name: soffset, type: sgpr|imm}
      - {name: offset, type: offset, optional: true}
    latency: 120  # Even lower on GFX950
    architectures: [gfx950]
    special:
      memory: true

  buffer_load_dwordx4:
    mnemonic: buffer_load_dwordx4
    category: vmem
    format: mtbuf
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: vaddr, type: vgpr}
      - {name: srd, type: sgpr_quad}
      - {name: soffset, type: sgpr|imm}
      - {name: offset, type: offset, optional: true}
    latency: 120
    architectures: [gfx950]
    special:
      memory: true

  # Buffer load with LDS - critical for gather-to-shared
  buffer_load_dword_lds:
    mnemonic: buffer_load_dword
    category: vmem
    format: mtbuf
    defs: []
    uses:
      - {name: vaddr, type: vgpr}
      - {name: srd, type: sgpr_quad}
      - {name: soffset, type: sgpr|imm}
      - {name: offset, type: offset, optional: true}
    latency: 120
    architectures: [gfx950]
    special:
      memory: true
      lds_modifier: true

  buffer_load_dwordx4_lds:
    mnemonic: buffer_load_dwordx4
    category: vmem
    format: mtbuf
    defs: []
    uses:
      - {name: vaddr, type: vgpr}
      - {name: srd, type: sgpr_quad}
      - {name: soffset, type: sgpr|imm}
      - {name: offset, type: offset, optional: true}
    latency: 120
    architectures: [gfx950]
    special:
      memory: true
      lds_modifier: true

  # ===========================================================================
  # GFX950 Scalar Memory
  # ===========================================================================

  s_load_dwordx2:
    mnemonic: s_load_dwordx2
    category: smem
    format: smem
    defs:
      - {name: dst, type: sgpr_pair, alignment: 2}
    uses:
      - {name: base, type: sgpr_pair}
      - {name: offset, type: imm|sgpr}
    latency: 80  # Very low on GFX950
    architectures: [gfx950]
    special:
      memory: true

  s_load_dwordx4:
    mnemonic: s_load_dwordx4
    category: smem
    format: smem
    defs:
      - {name: dst, type: sgpr_quad, alignment: 4}
    uses:
      - {name: base, type: sgpr_pair}
      - {name: offset, type: imm|sgpr}
    latency: 80
    architectures: [gfx950]
    special:
      memory: true

  # ===========================================================================
  # GFX950 LDS Operations
  # ===========================================================================

  ds_read_b64:
    mnemonic: ds_read_b64
    category: lds
    format: ds
    defs:
      - {name: dst, type: vgpr_pair, alignment: 2}
    uses:
      - {name: addr, type: vgpr}
      - {name: offset, type: offset, optional: true}
    latency: 12  # Very fast on GFX950
    architectures: [gfx950]
    special:
      memory: true
      offset_format: space_separated

  ds_read_b128:
    mnemonic: ds_read_b128
    category: lds
    format: ds
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: addr, type: vgpr}
      - {name: offset, type: offset, optional: true}
    latency: 12
    architectures: [gfx950]
    special:
      memory: true
      offset_format: space_separated
