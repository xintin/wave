# GFX942 (CDNA3 / MI300) specific instructions and overrides
#
# This file extends common.yaml with instructions specific to GFX942.
# Instructions defined here override any same-named instructions from common.yaml.
#
# GFX942 (CDNA3) features:
# - Improved MFMA throughput
# - Additional FP8 instructions
# - Enhanced memory subsystem

instructions:
  # ===========================================================================
  # GFX942-specific MFMA Instructions
  # ===========================================================================

  # FP8 Matrix Multiply-Add (CDNA3 only)
  v_mfma_f32_16x16x32_fp8_fp8:
    mnemonic: v_mfma_f32_16x16x32_fp8_fp8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 64
    architectures: [gfx942]
    special:
      accumulator: true

  v_mfma_f32_32x32x16_fp8_fp8:
    mnemonic: v_mfma_f32_32x32x16_fp8_fp8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_16, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_16}
    latency: 64
    architectures: [gfx942]
    special:
      accumulator: true

  v_mfma_f32_16x16x32_bf8_bf8:
    mnemonic: v_mfma_f32_16x16x32_bf8_bf8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 64
    architectures: [gfx942]
    special:
      accumulator: true

  v_mfma_f32_32x32x16_bf8_bf8:
    mnemonic: v_mfma_f32_32x32x16_bf8_bf8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_16, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_16}
    latency: 64
    architectures: [gfx942]
    special:
      accumulator: true

  # Mixed precision MFMA (FP8/BF8 with F32 accumulator)
  v_mfma_f32_16x16x32_fp8_bf8:
    mnemonic: v_mfma_f32_16x16x32_fp8_bf8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 64
    architectures: [gfx942]
    special:
      accumulator: true

  v_mfma_f32_16x16x32_bf8_fp8:
    mnemonic: v_mfma_f32_16x16x32_bf8_fp8
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 64
    architectures: [gfx942]
    special:
      accumulator: true

  # ===========================================================================
  # GFX942-specific Conversion Instructions
  # ===========================================================================

  v_cvt_pk_fp8_f32:
    mnemonic: v_cvt_pk_fp8_f32
    category: valu
    format: vop3p
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src0, type: vgpr|sgpr|imm}
      - {name: src1, type: vgpr|sgpr|imm}
    latency: 4
    architectures: [gfx942]

  v_cvt_pk_bf8_f32:
    mnemonic: v_cvt_pk_bf8_f32
    category: valu
    format: vop3p
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src0, type: vgpr|sgpr|imm}
      - {name: src1, type: vgpr|sgpr|imm}
    latency: 4
    architectures: [gfx942]

  v_cvt_f32_fp8:
    mnemonic: v_cvt_f32_fp8
    category: valu
    format: vop1
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src, type: vgpr|sgpr|imm}
    latency: 4
    architectures: [gfx942]

  v_cvt_f32_bf8:
    mnemonic: v_cvt_f32_bf8
    category: valu
    format: vop1
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: src, type: vgpr|sgpr|imm}
    latency: 4
    architectures: [gfx942]

  # ===========================================================================
  # GFX942 Latency Overrides
  # ===========================================================================
  # Override base latencies for GFX942-specific timing

  # Buffer loads have lower latency on MI300
  buffer_load_dword:
    mnemonic: buffer_load_dword
    category: vmem
    format: mtbuf
    defs:
      - {name: dst, type: vgpr}
    uses:
      - {name: vaddr, type: vgpr}
      - {name: srd, type: sgpr_quad}
      - {name: soffset, type: sgpr|imm}
      - {name: offset, type: offset, optional: true}
    latency: 150  # Lower than generic 200
    architectures: [gfx942]
    special:
      memory: true

  buffer_load_dwordx4:
    mnemonic: buffer_load_dwordx4
    category: vmem
    format: mtbuf
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: vaddr, type: vgpr}
      - {name: srd, type: sgpr_quad}
      - {name: soffset, type: sgpr|imm}
      - {name: offset, type: offset, optional: true}
    latency: 150
    architectures: [gfx942]
    special:
      memory: true

  # MFMA latency for MI300
  v_mfma_f32_16x16x16_f16:
    mnemonic: v_mfma_f32_16x16x16_f16
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_quad}
    latency: 32  # Lower than generic 64 on MI300
    architectures: [gfx942]
    special:
      accumulator: true

  v_mfma_f32_32x32x8_f16:
    mnemonic: v_mfma_f32_32x32x8_f16
    category: mfma
    format: vop3p
    defs:
      - {name: dst, type: vgpr_16, alignment: 4}
    uses:
      - {name: a, type: vgpr_pair}
      - {name: b, type: vgpr_pair}
      - {name: c, type: vgpr_16}
    latency: 32
    architectures: [gfx942]
    special:
      accumulator: true

  # ===========================================================================
  # GFX942 Scalar Memory (improved latency)
  # ===========================================================================

  s_load_dwordx2:
    mnemonic: s_load_dwordx2
    category: smem
    format: smem
    defs:
      - {name: dst, type: sgpr_pair, alignment: 2}
    uses:
      - {name: base, type: sgpr_pair}
      - {name: offset, type: imm|sgpr}
    latency: 100  # Lower than generic 200
    architectures: [gfx942]
    special:
      memory: true

  s_load_dwordx4:
    mnemonic: s_load_dwordx4
    category: smem
    format: smem
    defs:
      - {name: dst, type: sgpr_quad, alignment: 4}
    uses:
      - {name: base, type: sgpr_pair}
      - {name: offset, type: imm|sgpr}
    latency: 100
    architectures: [gfx942]
    special:
      memory: true

  # ===========================================================================
  # GFX942 LDS (Local Data Share) - same latency
  # ===========================================================================

  ds_read_b64:
    mnemonic: ds_read_b64
    category: lds
    format: ds
    defs:
      - {name: dst, type: vgpr_pair, alignment: 2}
    uses:
      - {name: addr, type: vgpr}
      - {name: offset, type: offset, optional: true}
    latency: 16  # Slightly lower on MI300
    architectures: [gfx942]
    special:
      memory: true
      offset_format: space_separated

  ds_read_b128:
    mnemonic: ds_read_b128
    category: lds
    format: ds
    defs:
      - {name: dst, type: vgpr_quad, alignment: 4}
    uses:
      - {name: addr, type: vgpr}
      - {name: offset, type: offset, optional: true}
    latency: 16
    architectures: [gfx942]
    special:
      memory: true
      offset_format: space_separated
